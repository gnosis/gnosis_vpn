name: Build packages
on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to build"
        required: true
        type: choice
        options:
          - all
          - linux
          - mac
        default: "all"
      client_version:
        description: "Client Version"
        required: true
        type: string
        default: "latest"
      app_version:
        description: "App Version"
        required: true
        type: string
        default: "latest"
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true
jobs:
  setup:
    runs-on: ubuntu-latest
    name: Setup versions
    outputs:
      GNOSISVPN_PACKAGE_VERSION: ${{ steps.versions.outputs.GNOSISVPN_PACKAGE_VERSION }}
      GNOSISVPN_CLI_VERSION: ${{ steps.versions.outputs.GNOSISVPN_CLI_VERSION }}
      GNOSISVPN_APP_VERSION: ${{ steps.versions.outputs.GNOSISVPN_APP_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Determine versions
        id: versions
        shell: bash
        run: |
          export GNOSISVPN_PACKAGE_VERSION=$(date +%Y.%m.%d+build.%H%M%S)
          echo "GNOSISVPN_PACKAGE_VERSION=${GNOSISVPN_PACKAGE_VERSION}" | tee -a $GITHUB_OUTPUT

          if [[ -z "${{ inputs.client_version }}" ]] || [[ "${{ inputs.client_version }}" == "latest" ]]; then
            export GNOSISVPN_CLI_VERSION=$(gh release view --repo gnosis/gnosis_vpn-client --json tagName --jq .tagName 2>/dev/null)
            export GNOSISVPN_CLI_VERSION="${GNOSISVPN_CLI_VERSION#v}"
          else
            export GNOSISVPN_CLI_VERSION="${{ inputs.client_version }}"
          fi
          echo "GNOSISVPN_CLI_VERSION=${GNOSISVPN_CLI_VERSION}" | tee -a $GITHUB_OUTPUT

          if [[ -z "${{ inputs.app_version }}" ]] || [[ "${{ inputs.app_version }}" == "latest" ]]; then
            export GNOSISVPN_APP_VERSION=$(gh release view --repo gnosis/gnosis_vpn-app --json tagName --jq .tagName 2>/dev/null)
            export GNOSISVPN_APP_VERSION="${GNOSISVPN_APP_VERSION#v}"
          else
            export GNOSISVPN_APP_VERSION="${{ inputs.app_version }}"
          fi
          echo "GNOSISVPN_APP_VERSION=${GNOSISVPN_APP_VERSION}" | tee -a $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

  linux:
    runs-on: ubuntu-latest
    name: Build Linux
    if: inputs.platform == 'all' || inputs.platform == 'linux'
    needs: [setup]
    strategy:
      matrix:
        architecture:
          - nix: x86_64-linux
            nfpm: amd64
        distribution: [deb]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup GCP
        uses: hoprnet/hopr-workflows/actions/setup-gcp@master
        with:
          google-credentials: ${{ secrets.GCP_SA_GITHUB_ACTIONS }}
          install-sdk: "true"
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Build Linux package
        shell: bash
        run: |
          nix develop -c just all ${{ matrix.distribution }} ${{ matrix.architecture.nix }} false
        env:
          GH_TOKEN: ${{ github.token }}
          GNOSISVPN_PACKAGE_VERSION: ${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}
          GNOSISVPN_CLI_VERSION: ${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}
          GNOSISVPN_APP_VERSION: ${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}
          GNOSISVPN_PREVIOUS_CLI_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_CLI_VERSION }}
          GNOSISVPN_PREVIOUS_APP_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_APP_VERSION }}
          GNOSISVPN_CHANGELOG_FORMAT: debian
      - name: Upload Package
        uses: actions/upload-artifact@v5
        with:
          name: gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}
          path: ./build/packages/gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}
      - name: Upload Hash
        uses: actions/upload-artifact@v5
        with:
          name: gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}.sha256
          path: ./build/packages/gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}.sha256

  mac:
    runs-on: macos-15
    name: Build Mac
    if: inputs.platform == 'all' || inputs.platform == 'mac'
    needs: [setup]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup GCP
        uses: hoprnet/hopr-workflows/actions/setup-gcp@master
        with:
          google-credentials: ${{ secrets.GCP_SA_GITHUB_ACTIONS }}
          install-sdk: "true"
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
      - name: Create mac installer package
        shell: bash
        run: |
          nix develop -c just all dmg aarch64-darwin false
        env:
          GH_TOKEN: ${{ github.token }}
          GNOSISVPN_PACKAGE_VERSION: ${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}
          GNOSISVPN_CLI_VERSION: ${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}
          GNOSISVPN_APP_VERSION: ${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}
      - name: Upload Package
        uses: actions/upload-artifact@v5
        with:
          name: GnosisVPN-Installer-${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}.pkg
          path: ./build/packages/GnosisVPN-Installer-${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}.pkg
      - name: Upload Hash
        uses: actions/upload-artifact@v5
        with:
          name: GnosisVPN-Installer-${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}.pkg.sha256
          path: ./build/packages/GnosisVPN-Installer-${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}.pkg.sha256

  summary:
    runs-on: ubuntu-latest
    name: Build Summary
    if: always() && !cancelled() && !failure()
    needs: [setup, linux, mac]
    steps:
      - name: Display build info
        run: |
          echo "## Build completed successfully! :rocket:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Versions" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Package version:** \`${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Client version:** \`v${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **App version:** \`v${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Platform" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Built for:** \`${{ inputs.platform }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Download artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "Artifacts are available in the **Actions** tab under this workflow run." >> "$GITHUB_STEP_SUMMARY"
