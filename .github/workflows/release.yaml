name: Close release
on:
  repository_dispatch:
    types: [new_snapshot_release]
  workflow_dispatch:
    inputs:
      public_release:
        description: "Is this a public release?"
        required: true
        type: boolean
        default: false
      client_version:
        description: "Client Version"
        required: true
        type: string
        default: "latest"
      app_version:
        description: "App Version"
        required: true
        type: string
        default: "latest"
      sign:
        description: "Sign the package"
        required: true
        type: boolean
        default: true
concurrency:
  group: release
  cancel-in-progress: false
jobs:
  setup:
    runs-on: ubuntu-latest
    name: Setup versions
    outputs:
      GNOSISVPN_PACKAGE_VERSION: ${{ steps.versions.outputs.GNOSISVPN_PACKAGE_VERSION }}
      GNOSISVPN_CLI_VERSION: ${{ steps.versions.outputs.GNOSISVPN_CLI_VERSION }}
      GNOSISVPN_APP_VERSION: ${{ steps.versions.outputs.GNOSISVPN_APP_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Determine versions
        id: versions
        shell: bash
        run: |
          if [[ "${{ inputs.public_release }}" == true ]]; then
            export GNOSISVPN_PACKAGE_VERSION=${{ vars.GNOSISVPN_NEXT_RELEASE_VERSION }}
          else
            export GNOSISVPN_PACKAGE_VERSION=$(date +%Y.%m.%d+build.%H%M%S)
          fi
          echo "GNOSISVPN_PACKAGE_VERSION=${GNOSISVPN_PACKAGE_VERSION}" | tee -a $GITHUB_OUTPUT

          if [[ -z "${{ inputs.client_version }}" ]] || [[ "${{ inputs.client_version }}" == "latest" ]]; then
            export GNOSISVPN_CLI_VERSION=$(gh release view --repo gnosis/gnosis_vpn-client --json tagName --jq .tagName 2>/dev/null)
            export GNOSISVPN_CLI_VERSION="${GNOSISVPN_CLI_VERSION#v}"
          else
            export GNOSISVPN_CLI_VERSION="${{ inputs.client_version }}"
          fi
          echo "GNOSISVPN_CLI_VERSION=${GNOSISVPN_CLI_VERSION}" | tee -a $GITHUB_OUTPUT

          if [[ -z "${{ inputs.app_version }}" ]] || [[ "${{ inputs.app_version }}" == "latest" ]]; then
            export GNOSISVPN_APP_VERSION=$(gh release view --repo gnosis/gnosis_vpn-app --json tagName --jq .tagName 2>/dev/null)
            export GNOSISVPN_APP_VERSION="${GNOSISVPN_APP_VERSION#v}"
          else
            export GNOSISVPN_APP_VERSION="${{ inputs.app_version }}"
          fi
          echo "GNOSISVPN_APP_VERSION=${GNOSISVPN_APP_VERSION}" | tee -a $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

  linux:
    runs-on: ubuntu-latest
    name: Build Linux
    needs: [setup]
    strategy:
      matrix:
        architecture:
          - nix: x86_64-linux
            nfpm: amd64
          # - nix: aarch64-linux
          #   nfpm: arm64
        distribution: [deb]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup GCP
        uses: hoprnet/hopr-workflows/actions/setup-gcp@master
        with:
          google-credentials: ${{ secrets.GCP_SA_GITHUB_ACTIONS }}
          install-sdk: "true"
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Setup GPG key for signing
        if: inputs.sign
        run: |
          echo "${{ secrets.GNOSISVPN_GPG_PRIVATE_KEY }}" > /tmp/gnosis_vpn_gpg_key.asc
          chmod 600 /tmp/gnosis_vpn_gpg_key.asc
      - name: Build Linux package
        shell: bash
        working-directory: linux
        run: |
          nix develop -c just all ${{ matrix.distribution }} ${{ matrix.architecture.nix }} ${{ inputs.sign || false }}
        env:
          GH_TOKEN: ${{ github.token }}
          GNOSISVPN_PACKAGE_VERSION: ${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}
          GNOSISVPN_CLI_VERSION: ${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}
          GNOSISVPN_APP_VERSION: ${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}
          GNOSISVPN_PREVIOUS_CLI_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_CLI_VERSION }}
          GNOSISVPN_PREVIOUS_APP_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_APP_VERSION }}
          GNOSISVPN_GPG_PRIVATE_KEY_PATH: /tmp/gnosis_vpn_gpg_key.asc
          GNOSISVPN_GPG_PRIVATE_KEY_PASSWORD: ${{ secrets.GNOSISVPN_GPG_PRIVATE_KEY_PASSWORD }}
          GNOSISVPN_CHANGELOG_FORMAT: debian
      - name: Upload Package
        uses: actions/upload-artifact@v5
        with:
          name: gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}
          path: ./linux/build/packages/gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}
      - name: Upload Signature
        if: inputs.sign
        uses: actions/upload-artifact@v5
        with:
          name: gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}.asc
          path: ./linux/build/packages/gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}.asc
      - name: Upload Hash
        uses: actions/upload-artifact@v5
        with:
          name: gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}.sha256
          path: ./linux/build/packages/gnosisvpn_${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}_${{ matrix.architecture.nfpm }}.${{ matrix.distribution }}.sha256

  mac:
    runs-on: macos-15
    name: Build Mac installer
    needs: [setup]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup GCP
        uses: hoprnet/hopr-workflows/actions/setup-gcp@master
        with:
          google-credentials: ${{ secrets.GCP_SA_GITHUB_ACTIONS }}
          install-sdk: "true"
      - name: Create mac installer package
        shell: bash
        working-directory: mac
        run: |
          if [[ -z "${{ inputs.sign }}" ]] || [[ "${{ inputs.sign }}" = true ]]; then
            echo "${{ secrets.GNOSISVPN_APPLE_CERTIFICATE_DEVELOPER }}" | base64 --decode > gnosisvpn-developer.p12
            echo "${{ secrets.GNOSISVPN_APPLE_CERTIFICATE_INSTALLER }}" | base64 --decode > gnosisvpn-installer.p12
            SIGNING_PARAMETERS="--sign --binary-certificate-path gnosisvpn-developer.p12 --installer-certificate-path gnosisvpn-installer.p12"
          fi
          ./build-package.sh  $SIGNING_PARAMETERS
          mv ./build/GnosisVPN-Installer-*-signed.pkg "./build/GnosisVPN-Installer.pkg"
          mv ./build/GnosisVPN-Installer-*-signed.pkg.sha256 "./build/GnosisVPN-Installer.pkg.sha256"
        env:
          GH_TOKEN: ${{ github.token }}
          GNOSISVPN_PACKAGE_VERSION: ${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}
          GNOSISVPN_CLI_VERSION: ${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}
          GNOSISVPN_APP_VERSION: ${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}
          GNOSISVPN_APPLE_CERTIFICATE_DEVELOPER_PASSWORD: ${{ secrets.GNOSISVPN_APPLE_CERTIFICATE_DEVELOPER_PASSWORD }}
          GNOSISVPN_APPLE_CERTIFICATE_INSTALLER_PASSWORD: ${{ secrets.GNOSISVPN_APPLE_CERTIFICATE_INSTALLER_PASSWORD }}
          GNOSISVPN_APPLE_ID: ${{ secrets.GNOSISVPN_APPLE_ID }}
          GNOSISVPN_APPLE_TEAM_ID: ${{ secrets.GNOSISVPN_APPLE_TEAM_ID }}
          GNOSISVPN_APPLE_PASSWORD: ${{ secrets.GNOSISVPN_APPLE_PASSWORD }}
      - name: Upload Package
        uses: actions/upload-artifact@v5
        with:
          name: GnosisVPN-Installer.pkg
          path: ./mac/build/GnosisVPN-Installer.pkg
      - name: Upload Signature
        uses: actions/upload-artifact@v5
        with:
          name: GnosisVPN-Installer.pkg.sha256
          path: ./mac/build/GnosisVPN-Installer.pkg.sha256

  release:
    runs-on: ubuntu-latest
    name: Release
    needs: [setup, linux, mac]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Display versions
        run: |
          echo "- Package version: ${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Client version: v${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- App version: v${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./binaries
      - name: Generate Release Notes
        run: linux/scripts/generate-changelog.sh
        env:
          GH_TOKEN: ${{ github.token }}
          GNOSISVPN_PACKAGE_VERSION: ${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}
          GNOSISVPN_CLI_VERSION: ${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}
          GNOSISVPN_APP_VERSION: ${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}
          GNOSISVPN_PREVIOUS_CLI_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_CLI_VERSION }}
          GNOSISVPN_PREVIOUS_APP_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_APP_VERSION }}
          GNOSISVPN_CHANGELOG_FORMAT: github

      - name: Create release
        if: inputs.public_release
        run: |
          if [ ! -d ./binaries ]; then
            echo "No binaries found to upload. Exiting."
            exit 1
          fi
          next_release_version=${{ vars.GNOSISVPN_NEXT_RELEASE_VERSION }}

          # Delete existing release if it exists
          gh release delete v${next_release_version} --yes 2>/dev/null || true

          gh release create v${next_release_version} \
            --title "GnosisVPN v${next_release_version}" \
            --notes-file linux/build/changelog/changelog

          echo "Preparing binaries for upload"

          # Upload all files from all artifact directories
          find ./binaries -type f -exec gh release upload v${next_release_version} {} --clobber \;

          echo "Release v${next_release_version} created and binaries uploaded"
        env:
          GH_TOKEN: ${{ secrets.GNOSIS_GITHUB_WORKFLOW_TOKEN }}
      - name: Bump Version
        id: bump
        if: inputs.public_release
        shell: bash
        run: |
          next_release_version=${{ vars.GNOSISVPN_NEXT_RELEASE_VERSION }}
          # Extract parts without IFS or read
          IFS='.' read -r major_version minor_version patch_version <<< "${next_release_version}"
          patch_version=$((patch_version+1))
          bumped_release_version="${major_version}.${minor_version}.${patch_version}"
          echo "released_version=$next_release_version" >> $GITHUB_OUTPUT
          gh variable set GNOSISVPN_NEXT_RELEASE_VERSION --body "$bumped_release_version"
          gh variable set GNOSISVPN_PREVIOUS_CLI_VERSION --body "${{ needs.setup.outputs.GNOSISVPN_CLI_VERSION }}"
          gh variable set GNOSISVPN_PREVIOUS_APP_VERSION --body "${{ needs.setup.outputs.GNOSISVPN_APP_VERSION }}"
        env:
          GH_TOKEN: ${{ secrets.GNOSIS_GITHUB_WORKFLOW_TOKEN }}
      - name: Prepare notification message
        run: |
          if [[ "${{ inputs.public_release }}" == "true" ]]; then
            RELEASE_TYPE="official"
          else
            RELEASE_TYPE="snapshot"
          fi
          # Build the notification message with release notes content
          {
            echo "I'm thrilled to inform a new \`gnosis_vpn\` ${RELEASE_TYPE} version \`${{ needs.setup.outputs.GNOSISVPN_PACKAGE_VERSION }}\` has been released."
            echo ""
            cat linux/build/changelog/changelog
          } > notification_message.txt

          # Store content in environment variable for the Zulip action
          {
            echo "NOTIFICATION_CONTENT<<EOF"
            cat notification_message.txt
            echo "EOF"
          } >> $GITHUB_ENV
      - name: Notify release
        if: inputs.public_release || github.event_name == 'repository_dispatch'
        uses: zulip/github-actions-zulip/send-message@e4c8f27c732ba9bd98ac6be0583096dea82feea5 # v1.0.2
        with:
          api-key: ${{ secrets.ZULIP_API_KEY }}
          email: ${{ secrets.ZULIP_EMAIL }}
          organization-url: "https://hopr.zulipchat.com"
          type: "stream"
          to: "GnosisVPN"
          topic: "Releases"
          content: ${{ env.NOTIFICATION_CONTENT }}
