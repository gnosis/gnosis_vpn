name: Close release
on:
  repository_dispatch:
    types: [new_snapshot_release]
  workflow_dispatch:
    inputs:
      public_release:
        description: "Is this a public release?"
        required: true
        type: boolean
        default: false
      client_version:
        description: "Client Version"
        required: true
        type: string
        default: "latest"
      app_version:
        description: "App Version"
        required: true
        type: string
        default: "latest"
concurrency:
  group: release
  cancel-in-progress: false
jobs:
  build:
    uses: ./.github/workflows/build.yaml
    with:
      public_release: ${{ inputs.public_release }}
      client_version: ${{ inputs.client_version }}
      app_version: ${{ inputs.app_version }}

  release:
    runs-on: ubuntu-latest
    name: Release
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Display versions
        run: |
          echo "- Package version: ${{ needs.build.outputs.GNOSISVPN_PACKAGE_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Client version: v${{ needs.build.outputs.GNOSISVPN_CLI_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- App version: v${{ needs.build.outputs.GNOSISVPN_APP_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./binaries
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Generate Release Notes
        run: nix develop -c ./scripts/generate-changelog.ts
        env:
          GH_TOKEN: ${{ github.token }}
          GNOSISVPN_PACKAGE_VERSION: ${{ needs.build.outputs.GNOSISVPN_PACKAGE_VERSION }}
          GNOSISVPN_CLI_VERSION: ${{ needs.build.outputs.GNOSISVPN_CLI_VERSION }}
          GNOSISVPN_APP_VERSION: ${{ needs.build.outputs.GNOSISVPN_APP_VERSION }}
          GNOSISVPN_PREVIOUS_CLI_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_CLI_VERSION }}
          GNOSISVPN_PREVIOUS_APP_VERSION: ${{ vars.GNOSISVPN_PREVIOUS_APP_VERSION }}
          GNOSISVPN_CHANGELOG_FORMAT: github

      - name: Create release
        if: inputs.public_release
        run: |
          if [ ! -d ./binaries ]; then
            echo "No binaries found to upload. Exiting."
            exit 1
          fi
          next_release_version=${{ vars.GNOSISVPN_NEXT_RELEASE_VERSION }}

          # Delete existing release if it exists
          gh release delete v${next_release_version} --yes 2>/dev/null || true

          gh release create v${next_release_version} \
            --title "GnosisVPN v${next_release_version}" \
            --notes-file ./build/changelog/changelog

          echo "Preparing binaries for upload"

          # Upload all files from all artifact directories
          find ./binaries -type f -exec gh release upload v${next_release_version} {} --clobber \;

          echo "Release v${next_release_version} created and binaries uploaded"
        env:
          GH_TOKEN: ${{ secrets.GNOSIS_GITHUB_WORKFLOW_TOKEN }}
      - name: Bump Version
        id: bump
        if: inputs.public_release
        shell: bash
        run: |
          next_release_version=${{ vars.GNOSISVPN_NEXT_RELEASE_VERSION }}
          # Extract parts without IFS or read
          IFS='.' read -r major_version minor_version patch_version <<< "${next_release_version}"
          patch_version=$((patch_version+1))
          bumped_release_version="${major_version}.${minor_version}.${patch_version}"
          echo "released_version=$next_release_version" >> $GITHUB_OUTPUT
          gh variable set GNOSISVPN_NEXT_RELEASE_VERSION --body "$bumped_release_version"
          gh variable set GNOSISVPN_PREVIOUS_CLI_VERSION --body "${{ needs.build.outputs.GNOSISVPN_CLI_VERSION }}"
          gh variable set GNOSISVPN_PREVIOUS_APP_VERSION --body "${{ needs.build.outputs.GNOSISVPN_APP_VERSION }}"
        env:
          GH_TOKEN: ${{ secrets.GNOSIS_GITHUB_WORKFLOW_TOKEN }}
      - name: Prepare notification message
        run: |
          if [[ "${{ inputs.public_release }}" == "true" ]]; then
            RELEASE_TYPE="official"
          else
            RELEASE_TYPE="snapshot"
          fi
          # Build the notification message with release notes content
          {
            echo "I'm thrilled to inform a new \`gnosis_vpn\` ${RELEASE_TYPE} version \`${{ needs.build.outputs.GNOSISVPN_PACKAGE_VERSION }}\` has been released."
            echo ""
            cat build/changelog/changelog
          } > notification_message.txt

          # Store content in environment variable for the Zulip action
          {
            echo "NOTIFICATION_CONTENT<<EOF"
            cat notification_message.txt
            echo "EOF"
          } >> $GITHUB_ENV
      - name: Notify release
        if: inputs.public_release || github.event_name == 'repository_dispatch'
        uses: zulip/github-actions-zulip/send-message@e4c8f27c732ba9bd98ac6be0583096dea82feea5 # v1.0.2
        with:
          api-key: ${{ secrets.ZULIP_API_KEY }}
          email: ${{ secrets.ZULIP_EMAIL }}
          organization-url: "https://hopr.zulipchat.com"
          type: "stream"
          to: "GnosisVPN"
          topic: "Releases"
          content: ${{ env.NOTIFICATION_CONTENT }}
