<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Gnosis VPN</title>
    <allowed-os-versions>
        <os-version min="14"/>
    </allowed-os-versions>
    <organization>com.gnosisvpn</organization>
    <domains enable_anywhere="true"/>

    <!-- Package metadata -->
    <pkg-ref id="com.gnosisvpn.gnosisvpnclient"/>

    <!-- Options -->
    <options customize="allow" require-scripts="false" hostArchitectures="x86_64,arm64"/>

    <!-- JavaScript functions for choice handling -->
    <script><![CDATA[
        function choicesPaneEntered() {
            // Set default selections
            if (choices.network.visible) {
                if (!choices.rotsee.selected && !choices.dufour.selected) {
                    choices.rotsee.selected = true;
                }
            }
            if (choices.servicemode.visible) {
                if (!choices.debug.selected && !choices.standard.selected) {
                    choices.debug.selected = true;
                }
            }
        }

        function choicesChanged() {
            // Ensure only one network is selected
            if (choices.rotsee.selected) {
                choices.dufour.selected = false;
            } else if (choices.dufour.selected) {
                choices.rotsee.selected = false;
            }

            // Ensure only one service mode is selected
            if (choices.debug.selected) {
                choices.standard.selected = false;
            } else if (choices.standard.selected) {
                choices.debug.selected = false;
            }
        }
    ]]></script>

    <!-- Welcome screen -->
    <welcome file="welcome.html" mime-type="text/html"/>

    <!-- Read Me screen with requirements -->
    <readme file="readme.html" mime-type="text/html"/>

    <!-- Conclusion screen with next steps -->
    <conclusion file="conclusion.html" mime-type="text/html"/>

    <!-- Choices outline - what the user sees -->
    <choices-outline>
        <line choice="default"/>
        <line choice="network">
            <line choice="rotsee"/>
            <line choice="dufour"/>
        </line>
        <line choice="servicemode">
            <line choice="debug"/>
            <line choice="standard"/>
        </line>
    </choices-outline>

    <!-- Default choice (always selected, hidden) -->
    <choice id="default"
            title="Gnosis VPN Client"
            description="Gnosis VPN client binaries and configuration"
            visible="false"
            enabled="true"
            selected="true">
        <pkg-ref id="com.gnosisvpn.gnosisvpnclient"/>
    </choice>

    <!-- Network selection choice (parent group) -->
    <choice id="network"
            title="HOPR Network"
            description="Select the HOPR network configuration for your VPN destinations"
            visible="true"
            enabled="false"
            start_selected="false">
    </choice>

    <!-- Rotsee network sub-choice -->
    <choice id="rotsee"
            title="Rotsee Network (Recommended)"
            description="Connect to VPN nodes on Rotsee network - US, UK, Brazil, Australia, India, South Korea"
            visible="true"
            enabled="true"
            selected="true"
            start_selected="true">
    </choice>

    <!-- Dufour network sub-choice -->
    <choice id="dufour"
            title="Dufour Network"
            description="Connect to VPN nodes on Dufour network - Germany, USA, Spain, India"
            visible="true"
            enabled="true"
            selected="false">
    </choice>

    <!-- Service mode selection choice (parent group) -->
    <choice id="servicemode"
            title="Service Configuration"
            description="Select the service configuration mode"
            visible="true"
            enabled="false"
            start_selected="false">
    </choice>

    <!-- Debug mode sub-choice -->
    <choice id="debug"
            title="Debug Mode (Recommended)"
            description="Install with debug logging enabled - useful for troubleshooting"
            visible="true"
            enabled="true"
            selected="true"
            start_selected="true">
    </choice>

    <!-- Standard mode sub-choice -->
    <choice id="standard"
            title="Standard Mode"
            description="Install with standard logging configuration"
            visible="true"
            enabled="true"
            selected="false">
    </choice>

    <!-- Component package reference -->
    <pkg-ref id="com.gnosisvpn.gnosisvpnclient"
             version="0"
             auth="root"
             installKBytes="16384"
             onConclusion="none">
        #GnosisVPN.pkg
    </pkg-ref>

    <!-- Installation requirements - pass choices to scripts as environment variables -->
    <installation-check script="choicesCheck()"/>

    <script><![CDATA[
        function choicesCheck() {
            // Set environment variables based on user choices
            if (choices.rotsee.selected) {
                system.env.INSTALLER_CHOICE_NETWORK = "rotsee";
            } else if (choices.dufour.selected) {
                system.env.INSTALLER_CHOICE_NETWORK = "dufour";
            } else {
                system.env.INSTALLER_CHOICE_NETWORK = "rotsee"; // default
            }

            if (choices.debug.selected) {
                system.env.INSTALLER_CHOICE_SERVICEMODE = "debug";
            } else if (choices.standard.selected) {
                system.env.INSTALLER_CHOICE_SERVICEMODE = "standard";
            } else {
                system.env.INSTALLER_CHOICE_SERVICEMODE = "debug"; // default
            }

            return true;
        }
    ]]></script>

    <!-- Localization (default English) -->
    <localization>
        <strings language="en">
            <![CDATA[
                // Installer strings
            ]]>
        </strings>
    </localization>

</installer-gui-script>
