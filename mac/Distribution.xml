<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Gnosis VPN</title>
    <allowed-os-versions>
        <os-version min="14"/>
    </allowed-os-versions>
    <organization>com.gnosisvpn</organization>
    <domains enable_anywhere="true"/>

    <!-- Package metadata -->
    <pkg-ref id="com.gnosisvpn.gnosisvpnclient"/>

    <!-- Options -->
    <options customize="allow" require-scripts="false" hostArchitectures="x86_64,arm64"/>

    <!-- JavaScript for mutual exclusion and state persistence -->
    <script><![CDATA[
        var NETWORK_CHOICES = ["rotsee", "jura", "dufour"];
        var LOGLEVEL_CHOICES = ["info", "debug"];

        function selectedCount(ids) {
            var n = 0;
            for (var i = 0; i < ids.length; i++) {
                var id = ids[i];
                if (!choices[id]) {
                    system.log("Choice id not found in choices[]: " + id);
                    continue;
                }
                if (choices[id].selected) n++;
            }
            return n;
        }

        // Mutual exclusion: when one is selected, the others become disabled.
        function exclusiveEnabled(selfId, groupIds) {
            if (choices[selfId].selected) return true;

            for (var i = 0; i < groupIds.length; i++) {
                var other = groupIds[i];
                if (other !== selfId && choices[other].selected) return false;
            }
            updateState(); // Update state on any change
            return true;
        }

        function getSelected(ids) {
            for (var i = 0; i < ids.length; i++) {
                if (choices[ids[i]] && choices[ids[i]].selected) return ids[i];
            }
            return "";
        }

        // Persist selected choices to a temporary file for postinstall script to read
        function updateState() {
             try {
                 var log_level = getSelected(LOGLEVEL_CHOICES) || 'info';
                 var network = getSelected(NETWORK_CHOICES) || 'rotsee';
                 var content = ""
                        + "INSTALLER_CHOICE_LOGLEVEL=" + log_level + "\n"
                        + "INSTALLER_CHOICE_NETWORK=" + network + "\n";
                 // Persist choices to a temporary file for postinstall script to read
                 system.run('/bin/sh', '-c', 'echo "' + content + '" > /Library/Logs/GnosisVPN/installer/gnosis_install_choices');
             } catch(e) {}
             return true;
        }

        // Ensure installer log directory exists at the time of installation check
        function installationCheck() {
            system.run('/bin/mkdir', '-p', '/Library/Logs/GnosisVPN/installer');
            updateState(); // Ensure state is saved at the time of installation check
            return true;
        }
    ]]></script>

    <!-- Installer background -->
    <background file="icon_bg_160x160.png" mime-type="image/png" alignment="bottomleft" scaling="none"/>
    <background-darkAqua file="icon_bg_white_160x160.png" mime-type="image/png" alignment="bottomleft" scaling="none"/>

    <!-- Welcome screen -->
    <welcome file="welcome.html" mime-type="text/html"/>

    <!-- Read Me screen with requirements -->
    <readme file="readme.html" mime-type="text/html"/>

    <!-- Conclusion screen with next steps -->
    <conclusion file="conclusion.html" mime-type="text/html"/>

    <installation-check script="installationCheck();" />

    <!-- Choices outline - what the user sees -->
    <choices-outline>
        <line choice="default"/>
        <line choice="network">
            <line choice="rotsee"/>
            <line choice="jura"/>
            <line choice="dufour"/>
        </line>
        <line choice="loglevel">
            <line choice="debug"/>
            <line choice="info"/>
        </line>
    </choices-outline>

    <!-- Default choice -->
    <choice id="default"
            title="Gnosis VPN Client"
            description="Gnosis VPN client binaries and configuration"
            enabled="false"
            selected="true">
        <pkg-ref id="com.gnosisvpn.gnosisvpnclient"/>
    </choice>

    <!-- Network selection choice (parent group) -->
    <choice id="network"
            title="HOPR Network"
            description="Select the HOPR network configuration for your VPN destinations"
            visible="true"
            enabled="true">
    </choice>

    <!-- Rotsee network sub-choice -->
    <choice id="rotsee"
            title="Rotsee (Recommended)"
            description="Connect to VPN nodes on the Rotsee network - US, UK, Brazil, Australia, India, South Korea"
            visible="true"
            enabled="exclusiveEnabled('rotsee', ['rotsee','jura','dufour'])"
            start_selected="true">
    </choice>

    <!-- Jura network sub-choice -->
    <choice id="jura"
            title="Jura"
            description="Connect to VPN nodes on the Jura network - US, UK, Brazil, Australia, India, South Korea"
            visible="true"
            start_selected="false"
            enabled="exclusiveEnabled('jura', ['rotsee','jura','dufour'])">
    </choice>

    <!-- Dufour network sub-choice -->
    <choice id="dufour"
            title="Dufour"
            description="Connect to VPN nodes on the Dufour network - Germany, USA, Spain, India"
            visible="true"
            start_selected="false"
            enabled="exclusiveEnabled('dufour', ['rotsee','jura','dufour'])">
    </choice>

    <!-- Service mode selection choice (parent group) -->
    <choice id="loglevel"
            title="Service Configuration"
            description="Select the service configuration mode"
            visible="true"
            enabled="true">
    </choice>

    <!-- Debug mode sub-choice -->
    <choice id="debug"
            title="Debug Mode (Recommended)"
            description="Install with debug logging enabled - useful for troubleshooting"
            visible="true"
            start_selected="false"
            enabled="exclusiveEnabled('debug', ['debug','info'])">
    </choice>

    <!-- Standard mode sub-choice -->
    <choice id="info"
            title="Standard Mode"
            description="Install with standard logging configuration"
            visible="true"
            enabled="exclusiveEnabled('info', ['debug','info'])"
            start_selected="true">
    </choice>

    <!-- Component package reference -->
    <pkg-ref id="com.gnosisvpn.gnosisvpnclient"
             version="0"
             auth="root"
             installKBytes="16384"
             onConclusion="none">
        #GnosisVPN.pkg
    </pkg-ref>

    <!-- Localization (default English) -->
    <localization>
        <strings language="en">
            <![CDATA[
                // Installer strings
            ]]>
        </strings>
    </localization>

</installer-gui-script>